var O=Object.defineProperty;var M=(a,e,o)=>e in a?O(a,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[e]=o;var i=(a,e,o)=>(M(a,typeof e!="symbol"?e+"":e,o),o);import{n as C,r as I,t as D,o as V,m as N,p as B}from"./vendor-fdf6ba46.js";import{d as W,a as h,f as J,I as U,l as $,m as j,M as u,Q as m,q as r,ak as K,U as A,ai as L,aj as q}from"./@vue-8492d132.js";import{_ as H}from"./console-form.vue_vue_type_script_setup_true_lang-e40e1a9b.js";import{_ as P}from"./index-f32ca7fa.js";class Q{constructor({onMessageCallback:e,wsuri:o,maxReconnectCount:c,onOpenCallback:p}){i(this,"heartbeatStr","ping");i(this,"onMessageCallback");i(this,"wsuri","");i(this,"maxReconnectCount",5);i(this,"onOpenCallback");i(this,"pingCount",0);i(this,"websocket",null);i(this,"connectRetryCount",0);i(this,"timeoutnum");i(this,"heartbeat");this.onMessageCallback=e,this.wsuri=o,this.maxReconnectCount=c??this.maxReconnectCount,this.onOpenCallback=p,this.initWebsocket()}initWebsocket(){this.websocket=new WebSocket(this.wsuri),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onopen=this.onOpen.bind(this),this.websocket.onerror=this.onError.bind(this),this.websocket.onclose=this.onClose.bind(this)}onMessage(e){e.data!==this.heartbeatStr&&this.onMessageCallback(e.data)}onOpen(){var e;this.connectRetryCount=0,console.log("建立连接"),(e=this.onOpenCallback)==null||e.call(this)}send(e){this.websocket.send(e)}onClose(){console.log("连接关闭")}onError(e){this.reconnect(),console.error("出现错误",e.target)}sendHeart(){this.heartbeat&&clearTimeout(this.heartbeat),this.heartbeat=setTimeout(()=>{var e;if(((e=this.websocket)==null?void 0:e.readyState)==1){const o={type:this.heartbeat,payload:`${this.pingCount}`};this.send(JSON.stringify(o)),this.pingCount++}else this.reconnect()},1e3)}reconnect(){if(this.connectRetryCount>=this.maxReconnectCount){this.timeoutnum&&clearTimeout(this.timeoutnum);return}this.timeoutnum&&clearTimeout(this.timeoutnum),console.log(`尝试重新连接-第 ${this.connectRetryCount+1}次`),this.timeoutnum=setTimeout(()=>{this.initWebsocket(),this.connectRetryCount+=1},1e4)}destory(){var e;(e=this.websocket)==null||e.close(),this.heartbeat&&clearTimeout(this.heartbeat),this.timeoutnum&&clearTimeout(this.timeoutnum)}}const f=a=>(L("data-v-82b39d93"),a=a(),q(),a),z={class:"p2p-container"},F=f(()=>r("div",{class:"video-container"},[r("video",{id:"remote-video",class:"video-dom",autoplay:"",playsinline:""}),r("div",{class:"video-title"},"远程视频")],-1)),G=f(()=>r("div",{class:"video-container"},[r("video",{id:"local-video",class:"video-dom",autoplay:"",playsinline:""}),r("div",{class:"video-title"},"本地视频")],-1)),X={class:"operation"},Y=f(()=>r("label",{class:"operation-label"},"房间号：",-1)),Z=W({__name:"single-remote",setup(a){const e=h(new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]})),o=h(e.value.createDataChannel("message",{ordered:!1,maxRetransmits:0})),c=h(new MediaStream),p=h(),_=h(""),g=h(!0);let b;const w=t=>{try{const n=JSON.parse(t);if(console.log(n),n.type==="answer"){const d=new RTCSessionDescription(n.payload);R(d)}else n.type}catch(n){console.error(n)}},y=()=>{if(!_.value){C.error("请输入房间号");return}b=new Q({wsuri:"ws://10.1.60.209:8080",onMessageCallback:w,onOpenCallback:S}),_.value=""},k=async()=>{const t=document.getElementById("local-video"),n=document.getElementById("remote-video");c.value=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:!0}),t.srcObject=c.value,c.value.getTracks().forEach(s=>{e.value.addTrack(s,c.value)});const d=new MediaStream;e.value.ontrack=s=>{s.streams[0].getTracks().forEach(l=>{d.addTrack(l)}),n.srcObject=d},c.value.getAudioTracks().forEach(s=>{s.enabled=!1}),o.value.onmessage=s=>{var l;(l=p.value)==null||l.writeInfo(`接收到的指令：${s.data}`)},e.value.ondatachannel=s=>{C.success("建立连接"),g.value=!1;const l=s.channel;l.onopen=()=>{console.log("建立连接!")},l.onmessage=v=>{console.log(v.data)}}};async function S(){e.value.onicecandidate=async t=>{t.candidate&&b.send(JSON.stringify({type:"candidate",payload:t.candidate}))};try{const t=await e.value.createOffer();await e.value.setLocalDescription(t),b.send(JSON.stringify({type:"offer",payload:t}))}catch(t){console.error(t)}}async function R(t){await e.value.setRemoteDescription(t),b.destory()}function T(){c.value.getTracks().forEach(t=>{t.stop()}),e.value.close()}return J(()=>{k()}),U(()=>{T()}),(t,n)=>{const d=I,s=D,l=V,v=N,E=B;return $(),j("div",z,[u(s,{class:"p2p-container__row"},{default:m(()=>[u(d,{span:12},{default:m(()=>[F]),_:1}),u(d,{span:12},{default:m(()=>[G]),_:1})]),_:1}),r("div",X,[u(E,{class:"box-card"},{default:m(()=>[Y,u(l,{modelValue:_.value,"onUpdate:modelValue":n[0]||(n[0]=x=>_.value=x),style:{width:"150px","margin-right":"20px"},placeholder:"要加入的房间号",clearable:"",onKeyup:K(y,["enter"])},null,8,["modelValue","onKeyup"]),u(v,{type:"primary",onClick:y},{default:m(()=>[A("加入")]),_:1})]),_:1}),u(H,{localStream:c.value,peerConnection:e.value,dataChannel:o.value,btnDiabled:g.value,ref_key:"consoleRef",ref:p},null,8,["localStream","peerConnection","dataChannel","btnDiabled"])])])}}});const se=P(Z,[["__scopeId","data-v-82b39d93"]]);export{se as default};
