var B=Object.defineProperty;var $=(c,e,s)=>e in c?B(c,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[e]=s;var i=(c,e,s)=>($(c,typeof e!="symbol"?e+"":e,s),s);import{n as S,r as A,t as J,o as W,m as j,p as H}from"./vendor-bd744d8f.js";import{d as K,b as h,r as L,j as U,J as q,m as z,q as P,O as l,R as d,ak as Z,V as R,ai as F,aj as G,t as u}from"./@vue-30559afa.js";import{_ as Q}from"./console-form.vue_vue_type_script_setup_true_lang-76aee368.js";import{_ as X}from"./index-bdc18048.js";class Y{constructor({onMessageCallback:e,wsuri:s,maxReconnectCount:r,onOpenCallback:p}){i(this,"heartbeatStr","ping");i(this,"onMessageCallback");i(this,"wsuri","");i(this,"maxReconnectCount",5);i(this,"onOpenCallback");i(this,"pingCount",0);i(this,"websocket",null);i(this,"connectRetryCount",0);i(this,"timeoutnum");i(this,"heartbeat");this.onMessageCallback=e,this.wsuri=s,this.maxReconnectCount=r??this.maxReconnectCount,this.onOpenCallback=p,this.initWebsocket()}initWebsocket(){this.websocket=new WebSocket(this.wsuri),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onopen=this.onOpen.bind(this),this.websocket.onerror=this.onError.bind(this),this.websocket.onclose=this.onClose.bind(this)}onMessage(e){e.data!==this.heartbeatStr&&this.onMessageCallback(e.data)}onOpen(){var e;this.connectRetryCount=0,console.log("websocket建立连接"),(e=this.onOpenCallback)==null||e.call(this)}send(e){this.websocket.send(e)}onClose(){console.log("websocket连接关闭")}onError(e){this.reconnect(),console.error("websocket出现错误",e.target)}sendHeart(){this.heartbeat&&clearTimeout(this.heartbeat),this.heartbeat=setTimeout(()=>{var e;if(((e=this.websocket)==null?void 0:e.readyState)==1){const s={type:this.heartbeat,payload:`${this.pingCount}`};this.send(JSON.stringify(s)),this.pingCount++}else this.reconnect()},1e3)}reconnect(){if(this.connectRetryCount>=this.maxReconnectCount){this.timeoutnum&&clearTimeout(this.timeoutnum);return}this.timeoutnum&&clearTimeout(this.timeoutnum),console.log(`尝试重新连接-第 ${this.connectRetryCount+1}次`),this.timeoutnum=setTimeout(()=>{this.initWebsocket(),this.connectRetryCount+=1},1e4)}destory(){var e;(e=this.websocket)==null||e.close(),this.heartbeat&&clearTimeout(this.heartbeat),this.timeoutnum&&clearTimeout(this.timeoutnum)}}const g=c=>(F("data-v-36ab7a6a"),c=c(),G(),c),ee={class:"p2p-container"},te=g(()=>u("div",{class:"video-container"},[u("video",{id:"remote-video",class:"video-dom",autoplay:"",playsinline:""}),u("div",{class:"video-title"},"远程视频")],-1)),ae=g(()=>u("div",{class:"video-container"},[u("video",{id:"local-video",class:"video-dom",autoplay:"",playsinline:""}),u("div",{class:"video-title"},"本地视频")],-1)),oe=g(()=>u("label",{class:"operation-label"},"连接地址：",-1)),ne=K({__name:"single-remote",setup(c){const e=h(null),s=h(null),r=h(new MediaStream),p=h(),b=h(""),m=h(!0),_=L({audio:!0,video:!0});let v;const T=o=>{try{const t=JSON.parse(o);if(console.log("服务端推送：",t),t.type==="answer"){const a=new RTCSessionDescription(t.payload);I(a)}else t.type==="candidate"&&V(new RTCIceCandidate(t.payload))}catch(t){console.error(t)}},C=()=>{const o=/^(ws:\/\/|wss:\/\/)[A-Za-z0-9\-._~:/?#[\]@!$&'()*+,;=]+$/,t=b.value.trim();if(!o.test(t)){S.error("请输入正确的websocket地址");return}v=new Y({wsuri:t,onMessageCallback:T,onOpenCallback:()=>{E(),O()}}),b.value=""},x=async()=>{const o=document.getElementById("local-video");r.value=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:!0}),o.srcObject=r.value,w(!1)},E=()=>{const o=document.getElementById("remote-video");e.value=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),s.value=e.value.createDataChannel("message",{ordered:!1,maxRetransmits:0}),r.value.getTracks().forEach(a=>{e.value.addTrack(a,r.value)});const t=new MediaStream;e.value.ontrack=a=>{a.streams[0].getTracks().forEach(n=>{t.addTrack(n)}),o.srcObject=t},e.value.oniceconnectionstatechange=()=>{var n;const a=(n=e.value)==null?void 0:n.iceConnectionState;console.log("peerConnection 状态:",a),a==="connected"&&(S.success("webtc连接已建立"),m.value=!1,v.destory()),(a==="disconnected"||a==="failed")&&console.log("peerConnection 远程连接已断开")},s.value.onmessage=a=>{var n;(n=p.value)==null||n.writeInfo(`接收到的指令：${a.data}`)},e.value.ondatachannel=a=>{const n=a.channel;n.onopen=()=>{n.send("webtc连接已建立!")},n.onmessage=f=>{console.log(f.data)}}};async function O(){var o,t;e.value.onicecandidate=async a=>{a.candidate&&v.send(JSON.stringify({type:"candidate",payload:a.candidate}))};try{const a=await((o=e.value)==null?void 0:o.createOffer());await((t=e.value)==null?void 0:t.setLocalDescription(a)),v.send(JSON.stringify({type:"offer",payload:a}))}catch(a){console.error(a)}}async function I(o){var t;try{await((t=e.value)==null?void 0:t.setRemoteDescription(o))}catch(a){console.error(a)}}async function V(o){var t;try{await((t=e.value)==null?void 0:t.addIceCandidate(o))}catch{}}const w=o=>{_.audio=o,r.value.getAudioTracks().forEach(t=>{t.enabled=o})},M=o=>{_.video=o,r.value.getVideoTracks().forEach(t=>{t.enabled=o})};function y(){var o,t;m.value=!0,(o=e.value)==null||o.close(),(t=p.value)==null||t.reduction()}return U(()=>{x()}),q(()=>{y()}),(o,t)=>{const a=A,n=J,f=W,k=j,D=H;return z(),P("div",ee,[l(n,{class:"p2p-container__row"},{default:d(()=>[l(a,{span:12},{default:d(()=>[te]),_:1}),l(a,{span:12},{default:d(()=>[ae]),_:1})]),_:1}),l(n,{class:"operation"},{default:d(()=>[l(a,{span:24,class:"margin-bottom-10"},{default:d(()=>[l(D,{class:"box-card"},{default:d(()=>[oe,l(f,{modelValue:b.value,"onUpdate:modelValue":t[0]||(t[0]=N=>b.value=N),disabled:!m.value,style:{width:"200px","margin-right":"10px"},placeholder:"请输入完整wesocket地址",clearable:"",onKeyup:Z(C,["enter"])},null,8,["modelValue","disabled","onKeyup"]),l(k,{type:"primary",onClick:C,disabled:!m.value},{default:d(()=>[R("加入")]),_:1},8,["disabled"]),l(k,{type:"danger",onClick:y,disabled:m.value},{default:d(()=>[R("关闭连接")]),_:1},8,["disabled"])]),_:1})]),_:1}),l(a,{span:24},{default:d(()=>[l(Q,{localStream:r.value,peerConnection:e.value,dataChannel:s.value,btnDiabled:m.value,mediaDevices:_,experiment:!1,onHandleAudio:w,onHandleVideo:M,ref_key:"consoleRef",ref:p},null,8,["localStream","peerConnection","dataChannel","btnDiabled","mediaDevices"])]),_:1})]),_:1})])}}});const de=X(ne,[["__scopeId","data-v-36ab7a6a"]]);export{de as default};
