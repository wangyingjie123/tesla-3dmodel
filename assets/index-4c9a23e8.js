import{m as T,o as $,V as N,W as P,X as A}from"./vendor-fec9aa6e.js";import{d as q,r as S,a as g,f as z,I as L,l as B,m as D,Z as W,q as F,M as d,Q as f,U as M,V as K,ak as H,$ as j}from"./@vue-8492d132.js";import{S as O,k as Q,U as X}from"./tensorflow-1325f1fd.js";import{_ as Z}from"./index-8cc47a06.js";const G=""+new URL("../video/dance.mp4",import.meta.url).href,J=(c,n=0,r=0)=>{if(c&&n&&r){const a=document.createElement("canvas"),l=a.getContext("2d");return a.width=n,a.height=r,l.drawImage(c,0,0,n,r),l.getImageData(0,0,n,r)}return null},Y=c=>{if(!c)return null;const{width:n,height:r}=c,a=document.createElement("canvas"),l=a.getContext("2d");return a.width=n,a.height=r,l.putImageData(c,0,0,0,0,n,r),a.toDataURL("image/png")},ee={class:"danmu"},te={class:"danmu-video","element-loading-text":"人物检测模型加载中... ","element-loading-background":"rgba(0, 0, 0, 0.7)"},ae=10,C=16,ne=4,oe=2,se=!1,re=.3,le=q({__name:"index",setup(c){const n=S({message:""}),r=g(!0),a=g(),l=g(),m=g(0),w=g(),b=new WeakMap;let u=0,x=0,_=0,v;const U=S({message:[{required:!0,message:"请输入一个弹幕",trigger:"change"}]}),k=async()=>{const e=J(a.value,u,x);if(e){const o={flipHorizontal:!1,multiSegmentaion:!1,segmentBodyParts:!1,segmentationThreshold:1},s=await(v==null?void 0:v.segmentPeople(e,o)),y=await X(s,{r:0,g:0,b:0,a:0},{r:0,g:0,b:0,a:255},se,re),p=Y(y);l.value.style["-webkit-mask-image"]=`url(${p})`,l.value.style["-webkit-mask-size"]=`${u}px ${x}px`}m.value===1&&(_=window.requestAnimationFrame(k))},h=e=>{const{left:o}=e.style,s=Number(o.replace("px",""));if(s>=-u){e.style.left=`${s-oe}px`;const i=window.requestAnimationFrame(()=>h(e));b.set(e,i);return}e&&(e.parentNode.removeChild(e),window.cancelAnimationFrame(b.get(e)),b.delete(e))},I=async()=>{var e;await((e=w.value)==null?void 0:e.validate((o,s)=>{var i;if(o){const t=document.createElement("span");t.innerText=n.message,t.style.fontSize=`${C}px`,t.style.fontWeight="500",t.style.color="#fff",t.style.whiteSpace="nowrap",t.style.position="absolute";const p=Math.floor(Math.random()*ae)*(C+ne)+C;t.style.top=`${p}px`,t.style.left=`${u}px`,l.value.appendChild(t),h(t),(i=w.value)==null||i.resetFields()}else console.log("error submit!",s)}))},R=()=>{const e=a.value;e.paused?(e.play(),m.value=1,k()):(e.pause(),m.value=2,window.cancelAnimationFrame(_))},V=async()=>{const e=O.MediaPipeSelfieSegmentation,o={runtime:"mediapipe",modelType:"landscape",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"};try{v=await Q(e,o),r.value=!1;const{width:i,height:t}=a.value.getBoundingClientRect();u=i,x=t,k()}catch(s){console.log(s)}};return z(()=>V()),L(()=>{_&&window.cancelAnimationFrame(_)}),(e,o)=>{const s=T,i=$,t=N,y=P,p=A;return B(),D("div",ee,[W((B(),D("div",te,[F("video",{src:G,class:"danmu-video-inner",preload:"true",ref_key:"videoRef",ref:a,loop:"","x5-video-player-fullscreen":"true","x5-playsinline":"true",playsInline:"","webkit-playsinline":"true",crossOrigin:"anonymous"},null,512),F("div",{class:"danmu-mask",ref_key:"barrageBoxRef",ref:l},null,512),d(s,{type:"primary",class:"danmu-video-btn",onClick:R},{default:f(()=>[M(K(m.value===1?"暂停":"播放"),1)]),_:1})])),[[p,r.value]]),d(y,{inline:!0,model:n,rules:U,disabled:r.value,ref_key:"ruleFormRef",ref:w,onSubmit:o[1]||(o[1]=j(()=>{},["stop","prevent"]))},{default:f(()=>[d(t,{label:"",prop:"message",class:"danmu-input"},{default:f(()=>[d(i,{modelValue:n.message,"onUpdate:modelValue":o[0]||(o[0]=E=>n.message=E),placeholder:"发送弹幕",onKeyup:H(I,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),d(t,null,{default:f(()=>[d(s,{type:"primary",onClick:I},{default:f(()=>[M("发送")]),_:1})]),_:1})]),_:1},8,["model","rules","disabled"])])}}});const ue=Z(le,[["__scopeId","data-v-cc51b57c"]]);export{ue as default};
