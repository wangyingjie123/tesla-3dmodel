import{m as M}from"./vendor-fec9aa6e.js";import{d as $,a as p,l as f,m as w,M as b,Q as C,U as S,V as B,q as l,f as U,I as V,O as R,a6 as L,Z as I,ah as E,ai as T,aj as F}from"./@vue-8492d132.js";import{_ as D}from"./index-8cc47a06.js";function O({stream:e,onstop:a}){const o={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:'video/webm; codecs="vp8,opus"'},s=new MediaRecorder(e,o);return s.start(),s.ondataavailable=i=>{const t=new Blob([i.data],{type:i.data.type});j(t)},s.onstop=i=>{console.log(`停止录制 ${i.type}`),a()},s}function j(e){const a=URL.createObjectURL(e),o=document.createElement("a");o.href=a,o.download=`${new Date().getTime()}.${e.type.split("/")[1]}`,o.click(),URL.revokeObjectURL(a)}const q={class:"shared"},P=$({__name:"shared",emits:["playStream"],setup(e,{emit:a}){const o=p(),s=p(!1);let i=null;const t=()=>{if(o.value){if(s.value){i==null||i.stop();return}s.value=!0,i=O({stream:o.value,onstop:()=>{s.value=!1}})}};async function _(){o.value=await navigator.mediaDevices.getDisplayMedia({audio:!0,video:!0}),a("playStream",o.value)}return(u,d)=>{const r=M;return f(),w("div",q,[b(r,{class:"margin-right-10",type:"success",onClick:_},{default:C(()=>[S("屏幕共享")]),_:1}),b(r,{type:s.value?"warning":"primary",onClick:t},{default:C(()=>[S(B(s.value?"停止录制":"开始录制"),1)]),_:1},8,["type"])])}}});function H(e,a){const o=e[0]-a[0],s=e[1]-a[1],i=e[2]-a[2];return Math.sqrt(o*o+s*s+i*i)}function G({realVideoImageData:e,backgroundImageData:a,backgroundColor:o,allowance:s,virtualVideoCtx:i}){for(let t=0;t<e.data.length;t+=4){const _=e.data[t],u=e.data[t+1],d=e.data[t+2],r=a.data[t],h=a.data[t+1],g=a.data[t+2],y=a.data[t+3];H([_,u,d],o)<s&&(e.data[t]=r,e.data[t+1]=h,e.data[t+2]=g,e.data[t+3]=y)}return i.putImageData(e,0,0),e}const N=$({setup(){const e=p();function a(){const u=e.value.getContext("2d",{willReadFrequently:!0}),d=new Image;return d.setAttribute("crossOrigin",""),new Promise(r=>{d.src="https://t7.baidu.com/it/u=1819248061,230866778&fm=193&f=GIF",d.onload=()=>{u.drawImage(d,0,0,e.value.width,e.value.height);const h=u.getImageData(0,0,e.value.width,e.value.height);r(h)}})}const o=480,s=300;function i(u,d){const r=document.createElement("canvas"),h=r.getContext("2d",{willReadFrequently:!0}),g=document.createElement("canvas"),y=g.getContext("2d");r.width=g.width=o,r.height=g.height=s,setInterval(()=>{h.drawImage(u,0,0,r.width,r.height);const n=h.getImageData(0,0,r.width,r.height);G({backgroundImageData:d,realVideoImageData:n,virtualVideoCtx:y,allowance:50,backgroundColor:[245,245,245]})},40),t(g)}function t(u){const d=document.querySelector("#virtual-video"),r=u.captureStream(30);d.srcObject=r}return{virtualVideoCanvas:e,onMounted:u=>{a().then(d=>{i(u,d)})}}}}),A={class:"videos margin-top-20"},W={ref:"virtualVideoCanvas",class:"margin-right-10",width:"480",height:"300"},Q=l("video",{id:"virtual-video",width:"480",height:"300",autoplay:"",muted:""},null,-1);function Z(e,a,o,s,i,t){return f(),w("div",A,[l("canvas",W,null,512),Q])}const z=D(N,[["render",Z]]),k=e=>(T("data-v-aa32f7fc"),e=e(),F(),e),J={class:"webrtc"},K={class:"webrtc-video margin-right-20"},X={class:"webrtc-img"},Y=["src"],ee={class:"webrtc-device margin-left-20"},te={class:"webrtc-device__list"},ae=k(()=>l("label",{class:"webrtc-device__label"},"切换设备",-1)),oe=["value"],ne={class:"webrtc-device__list"},se=k(()=>l("label",{class:"webrtc-device__label"},"切换方向",-1)),ie=k(()=>l("option",{value:1},"前置摄像头",-1)),ce=k(()=>l("option",{value:2},"后置摄像头",-1)),re=[ie,ce],de=$({__name:"index",setup(e){const a=p(),o=p([]),s=p(),i=p([]),t=p(1);let _;async function u(n){_=await navigator.mediaDevices.getUserMedia(n),d(_)}function d(n){a.value.srcObject=n}function r(){const n=a.value,c=document.createElement("canvas");c.width=n.videoWidth,c.height=n.videoHeight;const m=c.getContext("2d");m.drawImage(n,0,0,c.width,c.height),o.value.push(c.toDataURL("image/png"));const v=["blur(5px)","brightness(0.5)","contrast(200%)","grayscale(100%)","hue-rotate(90deg)","invert(100%)","opacity(90%)","saturate(200%)","saturate(20%)","sepia(100%)","drop-shadow(4px 4px 8px blue)"];o.value=[];for(let x=0;x<v.length;x++)m.filter=v[x],m.drawImage(n,0,0,c.width,c.height),o.value.push(c.toDataURL("image/png"))}const h=()=>{const n={video:!0,audio:!0};n.video={facingMode:{exact:t.value===1?"user":"environment"}},navigator.mediaDevices.getUserMedia(n).then(c=>{console.log("切换成功"),d(c)}).catch(c=>{console.error(`你的设备不支持切换前后摄像头 ${c}`)})};async function g(){const n=await navigator.mediaDevices.enumerateDevices();console.log("🚀🚀🚀 / 设备列表",n);const c=n.filter(m=>m.kind==="videoinput");i.value=c,console.log("🚀🚀🚀 / 摄像头列表",c)}const y=()=>{var n;(n=s.value)==null||n.onMounted(a.value)};return U(()=>{u({video:!0,audio:!0}),g()}),V(()=>{_.getVideoTracks().forEach(n=>{n.enabled=!1})}),(n,c)=>{const m=M;return f(),w(R,null,[l("div",J,[l("div",K,[l("video",{ref_key:"video",ref:a,class:"webrtc-video__inner",width:"480",height:"300",autoplay:"",playsinline:"",muted:""},null,512),b(m,{type:"primary",onClick:r,class:"button"},{default:C(()=>[S("拍摄")]),_:1}),b(m,{onClick:y},{default:C(()=>[S("设置虚拟背景")]),_:1})]),l("div",X,[(f(!0),w(R,null,L(o.value,(v,x)=>(f(),w("img",{key:x,src:v,alt:"",class:"webrtc-img__item margin-right-10 margin-bottom-10"},null,8,Y))),128))]),l("div",ee,[l("div",te,[ae,l("select",null,[(f(!0),w(R,null,L(i.value,v=>(f(),w("option",{key:v.deviceId,value:v.deviceId},B(v.label),9,oe))),128))])]),l("div",ne,[se,I(l("select",{"onUpdate:modelValue":c[0]||(c[0]=v=>t.value=v),onChange:h},re,544),[[E,t.value]])]),b(P,{onPlayStream:d})])]),b(z,{ref_key:"sonRef",ref:s},null,512)],64)}}});const _e=D(de,[["__scopeId","data-v-aa32f7fc"]]);export{_e as default};
