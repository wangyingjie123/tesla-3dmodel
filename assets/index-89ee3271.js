import{m as B}from"./vendor-ac01758b.js";import{d as $,b as m,m as f,q as w,O as b,R as C,V as S,W as D,t as l,j as U,J as V,P as R,a7 as L,_ as E,an as I,ao as T,ap as F}from"./@vue-cdc79bd8.js";import{_ as M}from"./index-21675fd9.js";function O({stream:e,onstop:o}){const a={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:'video/webm; codecs="vp8,opus"'},s=new MediaRecorder(e,a);return s.start(),s.ondataavailable=i=>{const t=new Blob([i.data],{type:i.data.type});P(t)},s.onstop=i=>{console.log(`停止录制 ${i.type}`),o()},s}function P(e){const o=URL.createObjectURL(e),a=document.createElement("a");a.href=o,a.download=`${new Date().getTime()}.${e.type.split("/")[1]}`,a.click(),URL.revokeObjectURL(o)}const j={class:"shared"},q=$({__name:"shared",emits:["playStream"],setup(e,{emit:o}){const a=m(),s=m(!1);let i=null;const t=()=>{if(a.value){if(s.value){i==null||i.stop();return}s.value=!0,i=O({stream:a.value,onstop:()=>{s.value=!1}})}};async function _(){a.value=await navigator.mediaDevices.getDisplayMedia({audio:!0,video:!0}),o("playStream",a.value)}return(u,d)=>{const r=B;return f(),w("div",j,[b(r,{class:"margin-right-10",type:"success",onClick:_},{default:C(()=>[S("屏幕共享")]),_:1}),b(r,{type:s.value?"warning":"primary",onClick:t},{default:C(()=>[S(D(s.value?"停止录制":"开始录制"),1)]),_:1},8,["type"])])}}});function H(e,o){const a=e[0]-o[0],s=e[1]-o[1],i=e[2]-o[2];return Math.sqrt(a*a+s*s+i*i)}function G({realVideoImageData:e,backgroundImageData:o,backgroundColor:a,allowance:s,virtualVideoCtx:i}){for(let t=0;t<e.data.length;t+=4){const _=e.data[t],u=e.data[t+1],d=e.data[t+2],r=o.data[t],h=o.data[t+1],p=o.data[t+2],y=o.data[t+3];H([_,u,d],a)<s&&(e.data[t]=r,e.data[t+1]=h,e.data[t+2]=p,e.data[t+3]=y)}return i.putImageData(e,0,0),e}const N=$({setup(){const e=m();function o(){const u=e.value.getContext("2d",{willReadFrequently:!0}),d=new Image;return d.setAttribute("crossOrigin",""),new Promise(r=>{d.src="https://t7.baidu.com/it/u=1819248061,230866778&fm=193&f=GIF",d.onload=()=>{u.drawImage(d,0,0,e.value.width,e.value.height);const h=u.getImageData(0,0,e.value.width,e.value.height);r(h)}})}const a=480,s=300;function i(u,d){const r=document.createElement("canvas"),h=r.getContext("2d",{willReadFrequently:!0}),p=document.createElement("canvas"),y=p.getContext("2d");r.width=p.width=a,r.height=p.height=s,setInterval(()=>{h.drawImage(u,0,0,r.width,r.height);const n=h.getImageData(0,0,r.width,r.height);G({backgroundImageData:d,realVideoImageData:n,virtualVideoCtx:y,allowance:50,backgroundColor:[245,245,245]})},40),t(p)}function t(u){const d=document.querySelector("#virtual-video"),r=u.captureStream(30);d.srcObject=r}return{virtualVideoCanvas:e,onMounted:u=>{o().then(d=>{i(u,d)})}}}}),W={class:"videos margin-top-20"},A={ref:"virtualVideoCanvas",class:"margin-right-10",width:"480",height:"300"},J=l("video",{id:"virtual-video",width:"480",height:"300",autoplay:"",muted:""},null,-1);function z(e,o,a,s,i,t){return f(),w("div",W,[l("canvas",A,null,512),J])}const K=M(N,[["render",z]]),k=e=>(T("data-v-88f37e12"),e=e(),F(),e),Q={class:"webrtc"},X={class:"webrtc-video margin-right-20"},Y={class:"webrtc-img"},Z=["src"],ee={class:"webrtc-device margin-left-20"},te={class:"webrtc-device__list"},oe=k(()=>l("label",{class:"webrtc-device__label"},"切换设备",-1)),ae=["value"],ne={class:"webrtc-device__list"},se=k(()=>l("label",{class:"webrtc-device__label"},"切换方向",-1)),ie=k(()=>l("option",{value:1},"前置摄像头",-1)),ce=k(()=>l("option",{value:2},"后置摄像头",-1)),re=[ie,ce],de=$({__name:"index",setup(e){const o=m(),a=m([]),s=m(),i=m([]),t=m(1);let _;async function u(n){_=await navigator.mediaDevices.getUserMedia(n),d(_)}function d(n){o.value.srcObject=n}function r(){const n=o.value,c=document.createElement("canvas");c.width=n.videoWidth,c.height=n.videoHeight;const g=c.getContext("2d");g.drawImage(n,0,0,c.width,c.height),a.value.push(c.toDataURL("image/png"));const v=["blur(5px)","brightness(0.5)","contrast(200%)","grayscale(100%)","hue-rotate(90deg)","invert(100%)","opacity(90%)","saturate(200%)","saturate(20%)","sepia(100%)","drop-shadow(4px 4px 8px blue)"];a.value=[];for(let x=0;x<v.length;x++)g.filter=v[x],g.drawImage(n,0,0,c.width,c.height),a.value.push(c.toDataURL("image/png"))}const h=()=>{const n={video:!0,audio:!0};n.video={facingMode:{exact:t.value===1?"user":"environment"}},navigator.mediaDevices.getUserMedia(n).then(c=>{console.log("切换成功"),d(c)}).catch(c=>{console.error(`你的设备不支持切换前后摄像头 ${c}`)})};async function p(){const n=await navigator.mediaDevices.enumerateDevices();console.log("🚀🚀🚀 / 设备列表",n);const c=n.filter(g=>g.kind==="videoinput");i.value=c,console.log("🚀🚀🚀 / 摄像头列表",c)}const y=()=>{var n;(n=s.value)==null||n.onMounted(o.value)};return U(()=>{u({video:!0,audio:!0}),p()}),V(()=>{_.getTracks().forEach(n=>{n.stop()})}),(n,c)=>{const g=B;return f(),w(R,null,[l("div",Q,[l("div",X,[l("video",{ref_key:"video",ref:o,class:"webrtc-video__inner",width:"480",height:"300",autoplay:"",playsinline:"",muted:""},null,512),b(g,{type:"primary",onClick:r,class:"button"},{default:C(()=>[S("拍摄")]),_:1}),b(g,{onClick:y},{default:C(()=>[S("设置虚拟背景")]),_:1})]),l("div",Y,[(f(!0),w(R,null,L(a.value,(v,x)=>(f(),w("img",{key:x,src:v,alt:"",class:"webrtc-img__item margin-right-10 margin-bottom-10"},null,8,Z))),128))]),l("div",ee,[l("div",te,[oe,l("select",null,[(f(!0),w(R,null,L(i.value,v=>(f(),w("option",{key:v.deviceId,value:v.deviceId},D(v.label),9,ae))),128))])]),l("div",ne,[se,E(l("select",{"onUpdate:modelValue":c[0]||(c[0]=v=>t.value=v),onChange:h},re,544),[[I,t.value]])]),b(q,{onPlayStream:d})])]),b(K,{ref_key:"sonRef",ref:s},null,512)],64)}}});const _e=M(de,[["__scopeId","data-v-88f37e12"]]);export{_e as default};
