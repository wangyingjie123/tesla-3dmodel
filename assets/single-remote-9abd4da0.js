var J=Object.defineProperty;var W=(n,e,s)=>e in n?J(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var c=(n,e,s)=>(W(n,typeof e!="symbol"?e+"":e,s),s);import{n as f,r as j,t as L,o as H,m as K,p as U,x as q}from"./vendor-4e5e14ef.js";import{d as z,b as u,r as P,j as Z,J as F,_ as G,m as Q,q as X,O as l,R as d,ak as Y,V as R,ai as ee,aj as te,t as h}from"./@vue-30559afa.js";import{_ as oe}from"./console-form.vue_vue_type_script_setup_true_lang-82354dea.js";import{_ as ae}from"./index-3b897f32.js";var S=(n=>(n[n.Normal=1e3]="Normal",n[n.Error=1001]="Error",n))(S||{});class ne{constructor({onMessageCallback:e,wsuri:s,maxReconnectCount:r,onOpenCallback:p,onCloseCallback:v}){c(this,"onMessageCallback");c(this,"wsuri","");c(this,"maxReconnectCount",5);c(this,"onOpenCallback");c(this,"onCloseCallback");c(this,"heartbeatStr","ping");c(this,"pingCount",0);c(this,"websocket",null);c(this,"isError",!1);c(this,"connectRetryCount",0);c(this,"timeoutnum");c(this,"heartbeat");this.onMessageCallback=e,this.wsuri=s,this.maxReconnectCount=r??this.maxReconnectCount,this.onOpenCallback=p,this.onCloseCallback=v,this.initWebsocket()}initWebsocket(){this.websocket=new WebSocket(this.wsuri),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onopen=this.onOpen.bind(this),this.websocket.onerror=this.onError.bind(this),this.websocket.onclose=this.onClose.bind(this)}onMessage(e){e.data!==this.heartbeatStr&&this.onMessageCallback(e.data)}onOpen(){var e;this.connectRetryCount=0,this.isError=!1,(e=this.onOpenCallback)==null||e.call(this)}send(e){this.websocket.send(e)}onClose(){var e,s;this.connectRetryCount===this.maxReconnectCount?(e=this.onCloseCallback)==null||e.call(this,1001):(s=this.onCloseCallback)==null||s.call(this,1e3),console.log("websocket连接关闭")}onError(e){this.reconnect(),this.isError=!0,console.error("websocket出现错误",e.target)}sendHeart(){this.heartbeat&&clearTimeout(this.heartbeat),this.heartbeat=setTimeout(()=>{var e;if(((e=this.websocket)==null?void 0:e.readyState)==1){const s={type:this.heartbeat,payload:`${this.pingCount}`};this.send(JSON.stringify(s)),this.pingCount++}else this.reconnect()},1e3)}reconnect(){if(this.connectRetryCount>=this.maxReconnectCount){this.timeoutnum&&clearTimeout(this.timeoutnum);return}this.timeoutnum&&clearTimeout(this.timeoutnum),console.log(`尝试重新连接-第 ${this.connectRetryCount+1}次`),this.timeoutnum=setTimeout(()=>{this.initWebsocket(),this.connectRetryCount+=1},1e4)}destory(){var e;(e=this.websocket)==null||e.close(),this.heartbeat&&clearTimeout(this.heartbeat),this.timeoutnum&&clearTimeout(this.timeoutnum)}}const w=n=>(ee("data-v-e21c89e7"),n=n(),te(),n),se={class:"p2p-container","element-loading-text":"正在建立连接..."},ie=w(()=>h("div",{class:"video-container"},[h("video",{id:"remote-video",class:"video-dom",autoplay:"",playsinline:""}),h("div",{class:"video-title"},"远程视频")],-1)),ce=w(()=>h("div",{class:"video-container"},[h("video",{id:"local-video",class:"video-dom",autoplay:"",playsinline:""}),h("div",{class:"video-title"},"本地视频")],-1)),le=w(()=>h("label",{class:"operation-label"},"连接地址：",-1)),re=z({__name:"single-remote",setup(n){const e=u(null),s=u(null),r=u(new MediaStream),p=u(),v=u(),m=u(!0),b=u(!1),y=P({audio:!0,video:!0});let _;const x=a=>{try{const o=JSON.parse(a);if(console.log("服务端推送：",o),o.type==="answer"){const t=new RTCSessionDescription(o.payload);V(t)}else o.type==="candidate"&&D(new RTCIceCandidate(o.payload))}catch(o){console.error(o)}},g=()=>{const a=/^(ws:\/\/|wss:\/\/)[A-Za-z0-9\-._~:/?#[\]@!$&'()*+,;=]+$/,o=v.value.trim();if(!a.test(o)){f.error("请输入正确的websocket地址");return}b.value=!0,_=new ne({wsuri:o,onMessageCallback:x,onOpenCallback:()=>{O(),I()},onCloseCallback:t=>{t===S.Error&&(f.error("尝试连接超过最大次数，请检查网络后刷新页面重试"),b.value=!1)}})},T=async()=>{try{const a=document.getElementById("local-video");r.value=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:!0}),a.srcObject=r.value,k(!1)}catch(a){f.error(`获取本地媒体流失败：${a}`)}},O=()=>{const a=document.getElementById("remote-video");e.value=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),r.value.getTracks().forEach(t=>{e.value.addTrack(t,r.value)});const o=new MediaStream;e.value.ontrack=t=>{t.streams[0].getTracks().forEach(i=>{o.addTrack(i)}),a.srcObject=o},e.value.oniceconnectionstatechange=()=>{var i;const t=(i=e.value)==null?void 0:i.iceConnectionState;console.log("peerConnection 状态:",t),t==="connected"?(f.success("webrtc连接已建立"),m.value=!1,b.value=!1,_.destory()):t==="disconnected"||t==="failed"?(C("网络异常，尝试重新连接"),g()):t==="closed"&&C()},s.value=e.value.createDataChannel("message",{ordered:!1,maxRetransmits:0}),s.value.onmessage=t=>{var i;(i=p.value)==null||i.writeInfo(`接收到的指令：${t.data}`)}};async function I(){var a,o;e.value.onicecandidate=async t=>{t.candidate&&_.send(JSON.stringify({type:"candidate",payload:t.candidate}))};try{const t=await((a=e.value)==null?void 0:a.createOffer());await((o=e.value)==null?void 0:o.setLocalDescription(t)),_.send(JSON.stringify({type:"offer",payload:t}))}catch(t){console.error(t)}}async function V(a){var o;try{await((o=e.value)==null?void 0:o.setRemoteDescription(a))}catch(t){console.error(t)}}async function D(a){var o;try{await((o=e.value)==null?void 0:o.addIceCandidate(a))}catch{}}const k=a=>{y.audio=a,r.value.getAudioTracks().forEach(o=>{o.enabled=a})},M=a=>{y.video=a,r.value.getVideoTracks().forEach(o=>{o.enabled=a})},C=a=>{var o,t,i;f.error(a||"webrtc连接已断开"),m.value=!0,b.value=!1,(o=s.value)==null||o.close(),(t=e.value)==null||t.close(),(i=p.value)==null||i.reduction()};return Z(()=>{T()}),F(()=>{C()}),(a,o)=>{const t=j,i=L,N=H,E=K,$=U,B=q;return G((Q(),X("div",se,[l(i,{class:"p2p-container__row"},{default:d(()=>[l(t,{span:12},{default:d(()=>[ie]),_:1}),l(t,{span:12},{default:d(()=>[ce]),_:1})]),_:1}),l(i,{class:"operation"},{default:d(()=>[l(t,{span:24,class:"margin-bottom-10"},{default:d(()=>[l($,{class:"box-card"},{default:d(()=>[le,l(N,{modelValue:v.value,"onUpdate:modelValue":o[0]||(o[0]=A=>v.value=A),disabled:!m.value,style:{width:"200px","margin-right":"10px"},placeholder:"请输入完整wesocket地址",clearable:"",onKeyup:Y(g,["enter"])},null,8,["modelValue","disabled","onKeyup"]),l(E,{type:"primary",onClick:g,disabled:!m.value},{default:d(()=>[R("加入")]),_:1},8,["disabled"]),l(E,{type:"danger",onClick:C,disabled:m.value},{default:d(()=>[R("关闭连接")]),_:1},8,["disabled"])]),_:1})]),_:1}),l(t,{span:24},{default:d(()=>[l(oe,{localStream:r.value,peerConnection:e.value,dataChannel:s.value,btnDiabled:m.value,mediaDevices:y,experiment:!1,onHandleAudio:k,onHandleVideo:M,ref_key:"consoleRef",ref:p},null,8,["localStream","peerConnection","dataChannel","btnDiabled","mediaDevices"])]),_:1})]),_:1})])),[[B,b.value]])}}});const ve=ae(re,[["__scopeId","data-v-e21c89e7"]]);export{ve as default};
