import{d as $,S,a as g,b as N,A as P,o as B,e as D,B as V,z as F,f as m,w as f,j as M,t as A,P as z,aX as q,aY as K,aZ as L,y as W,I as j,a_ as H,a$ as O,b0 as X,b1 as Y}from"./vendor-e3c25a1d.js";import{_ as Z}from"./index-3a9087c6.js";const G="/vue3-model/video/dance.mp4",J=(c,n=0,l=0)=>{if(c&&n&&l){const a=document.createElement("canvas"),r=a.getContext("2d");return a.width=n,a.height=l,r.drawImage(c,0,0,n,l),r.getImageData(0,0,n,l)}return null},Q=c=>{if(!c)return null;const{width:n,height:l}=c,a=document.createElement("canvas"),r=a.getContext("2d");return a.width=n,a.height=l,r.putImageData(c,0,0,0,0,n,l),a.toDataURL("image/png")},ee={class:"danmu"},te={class:"danmu-video","element-loading-text":"人物检测模型加载中... ","element-loading-background":"rgba(0, 0, 0, 0.7)"},ae=10,C=16,ne=4,oe=2,se=!1,le=.3,re=$({__name:"index",setup(c){const n=S({message:""}),l=g(!0),a=g(),r=g(),d=g(0),w=g(),b=new WeakMap;let u=0,x=0,_=0,v;const R=S({message:[{required:!0,message:"请输入一个弹幕",trigger:"change"}]}),k=async()=>{const e=J(a.value,u,x);if(e){const o={flipHorizontal:!1,multiSegmentaion:!1,segmentBodyParts:!1,segmentationThreshold:1},s=await(v==null?void 0:v.segmentPeople(e,o)),y=await Y(s,{r:0,g:0,b:0,a:0},{r:0,g:0,b:0,a:255},se,le),p=Q(y);r.value.style["-webkit-mask-image"]=`url(${p})`,r.value.style["-webkit-mask-size"]=`${u}px ${x}px`}d.value===1&&(_=window.requestAnimationFrame(k))},h=e=>{const{left:o}=e.style,s=Number(o.replace("px",""));if(s>=-u){e.style.left=`${s-oe}px`;const i=window.requestAnimationFrame(()=>h(e));b.set(e,i);return}e&&(e.parentNode.removeChild(e),window.cancelAnimationFrame(b.get(e)),b.delete(e))},I=async()=>{var e;await((e=w.value)==null?void 0:e.validate((o,s)=>{var i;if(o){const t=document.createElement("span");t.innerText=n.message,t.style.fontSize=`${C}px`,t.style.fontWeight="500",t.style.color="#fff",t.style.whiteSpace="nowrap",t.style.position="absolute";const p=Math.floor(Math.random()*ae)*(C+ne)+C;t.style.top=`${p}px`,t.style.left=`${u}px`,r.value.appendChild(t),h(t),(i=w.value)==null||i.resetFields()}else console.log("error submit!",s)}))},E=()=>{const e=a.value;e.paused?(e.play(),d.value=1,k()):(e.pause(),d.value=2,window.cancelAnimationFrame(_))},T=async()=>{const e=K.MediaPipeSelfieSegmentation,o={runtime:"mediapipe",modelType:"landscape",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"};try{v=await L(e,o),l.value=!1;const{width:i,height:t}=a.value.getBoundingClientRect();u=i,x=t,k()}catch(s){console.log(s)}};return N(()=>T()),P(()=>{_&&window.cancelAnimationFrame(_)}),(e,o)=>{const s=W,i=j,t=H,y=O,p=X;return B(),D("div",ee,[V((B(),D("div",te,[F("video",{src:G,class:"danmu-video-inner",preload:"true",ref_key:"videoRef",ref:a,loop:"","x5-video-player-fullscreen":"true","x5-playsinline":"true",playsInline:"","webkit-playsinline":"true",crossOrigin:"anonymous"},null,512),F("div",{class:"danmu-mask",ref_key:"barrageBoxRef",ref:r},null,512),m(s,{type:"primary",class:"danmu-video-btn",onClick:E},{default:f(()=>[M(A(d.value===1?"暂停":"播放"),1)]),_:1})])),[[p,l.value]]),m(y,{inline:!0,model:n,rules:R,disabled:l.value,ref_key:"ruleFormRef",ref:w,onSubmit:o[1]||(o[1]=q(()=>{},["stop","prevent"]))},{default:f(()=>[m(t,{label:"",prop:"message",class:"danmu-input"},{default:f(()=>[m(i,{modelValue:n.message,"onUpdate:modelValue":o[0]||(o[0]=U=>n.message=U),placeholder:"发送弹幕",onKeyup:z(I,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),m(t,null,{default:f(()=>[m(s,{type:"primary",onClick:I},{default:f(()=>[M("发送")]),_:1})]),_:1})]),_:1},8,["model","rules","disabled"])])}}});const de=Z(re,[["__scopeId","data-v-c1dc70a2"]]);export{de as default};
