var I=Object.defineProperty;var M=(n,e,a)=>e in n?I(n,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[e]=a;var c=(n,e,a)=>(M(n,typeof e!="symbol"?e+"":e,a),a);import{n as C,r as V,t as D,o as N,m as B,p as J}from"./vendor-5fa84e51.js";import{d as W,b as h,j as $,J as j,m as K,q as U,O as u,R as p,t as r,ak as A,V as L,ai as q,aj as H}from"./@vue-30559afa.js";import{_ as P}from"./console-form.vue_vue_type_script_setup_true_lang-3831c316.js";import{_ as z}from"./index-eb7a18f0.js";class F{constructor({onMessageCallback:e,wsuri:a,maxReconnectCount:i,onOpenCallback:_}){c(this,"heartbeatStr","ping");c(this,"onMessageCallback");c(this,"wsuri","");c(this,"maxReconnectCount",5);c(this,"onOpenCallback");c(this,"pingCount",0);c(this,"websocket",null);c(this,"connectRetryCount",0);c(this,"timeoutnum");c(this,"heartbeat");this.onMessageCallback=e,this.wsuri=a,this.maxReconnectCount=i??this.maxReconnectCount,this.onOpenCallback=_,this.initWebsocket()}initWebsocket(){this.websocket=new WebSocket(this.wsuri),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onopen=this.onOpen.bind(this),this.websocket.onerror=this.onError.bind(this),this.websocket.onclose=this.onClose.bind(this)}onMessage(e){e.data!==this.heartbeatStr&&this.onMessageCallback(e.data)}onOpen(){var e;this.connectRetryCount=0,console.log("建立连接"),(e=this.onOpenCallback)==null||e.call(this)}send(e){this.websocket.send(e)}onClose(){console.log("连接关闭")}onError(e){this.reconnect(),console.error("出现错误",e.target)}sendHeart(){this.heartbeat&&clearTimeout(this.heartbeat),this.heartbeat=setTimeout(()=>{var e;if(((e=this.websocket)==null?void 0:e.readyState)==1){const a={type:this.heartbeat,payload:`${this.pingCount}`};this.send(JSON.stringify(a)),this.pingCount++}else this.reconnect()},1e3)}reconnect(){if(this.connectRetryCount>=this.maxReconnectCount){this.timeoutnum&&clearTimeout(this.timeoutnum);return}this.timeoutnum&&clearTimeout(this.timeoutnum),console.log(`尝试重新连接-第 ${this.connectRetryCount+1}次`),this.timeoutnum=setTimeout(()=>{this.initWebsocket(),this.connectRetryCount+=1},1e4)}destory(){var e;(e=this.websocket)==null||e.close(),this.heartbeat&&clearTimeout(this.heartbeat),this.timeoutnum&&clearTimeout(this.timeoutnum)}}const f=n=>(q("data-v-92c0a958"),n=n(),H(),n),G={class:"p2p-container"},Q=f(()=>r("div",{class:"video-container"},[r("video",{id:"remote-video",class:"video-dom",autoplay:"",playsinline:""}),r("div",{class:"video-title"},"远程视频")],-1)),X=f(()=>r("div",{class:"video-container"},[r("video",{id:"local-video",class:"video-dom",autoplay:"",playsinline:""}),r("div",{class:"video-title"},"本地视频")],-1)),Y={class:"operation"},Z=f(()=>r("label",{class:"operation-label"},"房间号：",-1)),ee=W({__name:"single-remote",setup(n){const e=h(new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]})),a=h(e.value.createDataChannel("message",{ordered:!1,maxRetransmits:0})),i=h(new MediaStream),_=h(),m=h(""),g=h(!0);let v;const w=t=>{try{const o=JSON.parse(t);if(console.log(o),o.type==="answer"){const d=new RTCSessionDescription(o.payload);S(d)}else o.type==="candidate"&&T(new RTCIceCandidate(o.payload))}catch(o){console.error(o)}},y=()=>{if(!m.value){C.error("请输入房间号");return}v=new F({wsuri:`ws://${m.value.trim()}`,onMessageCallback:w,onOpenCallback:R}),m.value=""},k=async()=>{const t=document.getElementById("local-video"),o=document.getElementById("remote-video");i.value=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:!0}),t.srcObject=i.value,i.value.getTracks().forEach(s=>{e.value.addTrack(s,i.value)});const d=new MediaStream;e.value.ontrack=s=>{s.streams[0].getTracks().forEach(l=>{d.addTrack(l)}),o.srcObject=d},i.value.getAudioTracks().forEach(s=>{s.enabled=!1}),a.value.onmessage=s=>{var l;(l=_.value)==null||l.writeInfo(`接收到的指令：${s.data}`)},e.value.ondatachannel=s=>{C.success("建立连接"),g.value=!1;const l=s.channel;l.onopen=()=>{console.log("建立连接!")},l.onmessage=b=>{console.log(b.data)}}};async function R(){e.value.onicecandidate=async t=>{t.candidate&&v.send(JSON.stringify({type:"candidate",payload:t.candidate}))};try{const t=await e.value.createOffer();await e.value.setLocalDescription(t),v.send(JSON.stringify({type:"offer",payload:t}))}catch(t){console.error(t)}}async function S(t){await e.value.setRemoteDescription(t),v.destory()}async function T(t){try{await e.value.addIceCandidate(t)}catch(o){console.error(o)}}function E(){i.value.getTracks().forEach(t=>{t.stop()}),e.value.close()}return $(()=>{k()}),j(()=>{E()}),(t,o)=>{const d=V,s=D,l=N,b=B,O=J;return K(),U("div",G,[u(s,{class:"p2p-container__row"},{default:p(()=>[u(d,{span:12},{default:p(()=>[Q]),_:1}),u(d,{span:12},{default:p(()=>[X]),_:1})]),_:1}),r("div",Y,[u(O,{class:"box-card"},{default:p(()=>[Z,u(l,{modelValue:m.value,"onUpdate:modelValue":o[0]||(o[0]=x=>m.value=x),style:{width:"200px","margin-right":"20px"},placeholder:"要加入的房间号",clearable:"",onKeyup:A(y,["enter"])},null,8,["modelValue","onKeyup"]),u(b,{type:"primary",onClick:y},{default:p(()=>[L("加入")]),_:1})]),_:1}),u(P,{localStream:i.value,peerConnection:e.value,dataChannel:a.value,btnDiabled:g.value,ref_key:"consoleRef",ref:_},null,8,["localStream","peerConnection","dataChannel","btnDiabled"])])])}}});const ce=z(ee,[["__scopeId","data-v-92c0a958"]]);export{ce as default};
