var V=Object.defineProperty;var D=(s,e,n)=>e in s?V(s,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[e]=n;var i=(s,e,n)=>(D(s,typeof e!="symbol"?e+"":e,n),n);import{n as w,r as N,t as B,o as $,m as J,p as W}from"./vendor-5fa84e51.js";import{d as j,b as h,j as A,J as K,m as L,q as U,O as c,R as r,ak as q,V as k,ai as z,aj as H,t as u}from"./@vue-30559afa.js";import{_ as P}from"./console-form.vue_vue_type_script_setup_true_lang-a26b2ebf.js";import{_ as Z}from"./index-c6903b01.js";class F{constructor({onMessageCallback:e,wsuri:n,maxReconnectCount:d,onOpenCallback:p}){i(this,"heartbeatStr","ping");i(this,"onMessageCallback");i(this,"wsuri","");i(this,"maxReconnectCount",5);i(this,"onOpenCallback");i(this,"pingCount",0);i(this,"websocket",null);i(this,"connectRetryCount",0);i(this,"timeoutnum");i(this,"heartbeat");this.onMessageCallback=e,this.wsuri=n,this.maxReconnectCount=d??this.maxReconnectCount,this.onOpenCallback=p,this.initWebsocket()}initWebsocket(){this.websocket=new WebSocket(this.wsuri),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onopen=this.onOpen.bind(this),this.websocket.onerror=this.onError.bind(this),this.websocket.onclose=this.onClose.bind(this)}onMessage(e){e.data!==this.heartbeatStr&&this.onMessageCallback(e.data)}onOpen(){var e;this.connectRetryCount=0,console.log("建立连接"),(e=this.onOpenCallback)==null||e.call(this)}send(e){this.websocket.send(e)}onClose(){console.log("连接关闭")}onError(e){this.reconnect(),console.error("出现错误",e.target)}sendHeart(){this.heartbeat&&clearTimeout(this.heartbeat),this.heartbeat=setTimeout(()=>{var e;if(((e=this.websocket)==null?void 0:e.readyState)==1){const n={type:this.heartbeat,payload:`${this.pingCount}`};this.send(JSON.stringify(n)),this.pingCount++}else this.reconnect()},1e3)}reconnect(){if(this.connectRetryCount>=this.maxReconnectCount){this.timeoutnum&&clearTimeout(this.timeoutnum);return}this.timeoutnum&&clearTimeout(this.timeoutnum),console.log(`尝试重新连接-第 ${this.connectRetryCount+1}次`),this.timeoutnum=setTimeout(()=>{this.initWebsocket(),this.connectRetryCount+=1},1e4)}destory(){var e;(e=this.websocket)==null||e.close(),this.heartbeat&&clearTimeout(this.heartbeat),this.timeoutnum&&clearTimeout(this.timeoutnum)}}const f=s=>(z("data-v-1696b4f7"),s=s(),H(),s),G={class:"p2p-container"},Q=f(()=>u("div",{class:"video-container"},[u("video",{id:"remote-video",class:"video-dom",autoplay:"",playsinline:""}),u("div",{class:"video-title"},"远程视频")],-1)),X=f(()=>u("div",{class:"video-container"},[u("video",{id:"local-video",class:"video-dom",autoplay:"",playsinline:""}),u("div",{class:"video-title"},"本地视频")],-1)),Y=f(()=>u("label",{class:"operation-label"},"连接地址：",-1)),ee=j({__name:"single-remote",setup(s){const e=h(null),n=h(null),d=h(new MediaStream),p=h(),b=h(""),m=h(!0);let _;const S=o=>{try{const t=JSON.parse(o);if(console.log("服务端推送：",t),t.type==="answer"){const a=new RTCSessionDescription(t.payload);E(a)}else t.type==="candidate"&&O(new RTCIceCandidate(t.payload))}catch(t){console.error(t)}},g=()=>{const o=/^(ws:\/\/|wss:\/\/)[A-Za-z0-9\-._~:/?#[\]@!$&'()*+,;=]+$/,t=b.value.trim();if(!o.test(t)){w.error("请输入正确的websocket地址");return}_=new F({wsuri:t,onMessageCallback:S,onOpenCallback:()=>{x(),T()}}),b.value=""},R=async()=>{const o=document.getElementById("local-video");d.value=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:!0}),o.srcObject=d.value,d.value.getAudioTracks().forEach(t=>{t.enabled=!1})},x=()=>{const o=document.getElementById("remote-video");e.value=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),n.value=e.value.createDataChannel("message",{ordered:!1,maxRetransmits:0}),d.value.getTracks().forEach(a=>{e.value.addTrack(a,d.value)});const t=new MediaStream;e.value.ontrack=a=>{a.streams[0].getTracks().forEach(l=>{t.addTrack(l)}),o.srcObject=t},n.value.onmessage=a=>{var l;(l=p.value)==null||l.writeInfo(`接收到的指令：${a.data}`)},e.value.ondatachannel=a=>{w.success("建立连接"),m.value=!1;const l=a.channel;l.onopen=()=>{console.log("建立连接!")},l.onmessage=v=>{console.log(v.data)}}};async function T(){var o,t;e.value.onicecandidate=async a=>{a.candidate&&_.send(JSON.stringify({type:"candidate",payload:a.candidate}))};try{const a=await((o=e.value)==null?void 0:o.createOffer());await((t=e.value)==null?void 0:t.setLocalDescription(a)),_.send(JSON.stringify({type:"offer",payload:a}))}catch(a){console.error(a)}}async function E(o){var t;await((t=e.value)==null?void 0:t.setRemoteDescription(o)),_.destory()}async function O(o){var t;try{await((t=e.value)==null?void 0:t.addIceCandidate(o))}catch{}}function y(){var o,t;m.value=!0,(o=e.value)==null||o.close(),(t=p.value)==null||t.reduction()}return A(()=>{R()}),K(()=>{y()}),(o,t)=>{const a=N,l=B,v=$,C=J,I=W;return L(),U("div",G,[c(l,{class:"p2p-container__row"},{default:r(()=>[c(a,{span:12},{default:r(()=>[Q]),_:1}),c(a,{span:12},{default:r(()=>[X]),_:1})]),_:1}),c(l,{class:"operation",gutter:20},{default:r(()=>[c(a,{span:12},{default:r(()=>[c(I,{class:"box-card"},{default:r(()=>[Y,c(v,{modelValue:b.value,"onUpdate:modelValue":t[0]||(t[0]=M=>b.value=M),disabled:!m.value,style:{width:"200px","margin-right":"20px"},placeholder:"请输入完整wesocket地址",clearable:"",onKeyup:q(g,["enter"])},null,8,["modelValue","disabled","onKeyup"]),c(C,{type:"primary",onClick:g,disabled:!m.value},{default:r(()=>[k("加入")]),_:1},8,["disabled"]),c(C,{type:"danger",onClick:y,disabled:m.value},{default:r(()=>[k("关闭连接")]),_:1},8,["disabled"])]),_:1})]),_:1}),c(a,{span:12},{default:r(()=>[c(P,{localStream:d.value,peerConnection:e.value,dataChannel:n.value,btnDiabled:m.value,experiment:!1,ref_key:"consoleRef",ref:p},null,8,["localStream","peerConnection","dataChannel","btnDiabled"])]),_:1})]),_:1})])}}});const ie=Z(ee,[["__scopeId","data-v-1696b4f7"]]);export{ie as default};
