var x=Object.defineProperty;var O=(a,e,o)=>e in a?x(a,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[e]=o;var s=(a,e,o)=>(O(a,typeof e!="symbol"?e+"":e,o),o);import{n as y,r as M,t as D,o as I,m as V,p as N}from"./vendor-fdf6ba46.js";import{d as B,a as m,f as W,I as J,l as U,m as j,M as u,Q as p,q as l,ak as K,U as $,ai as A,aj as L}from"./@vue-8492d132.js";import{_ as q}from"./console-form.vue_vue_type_script_setup_true_lang-e40e1a9b.js";import{_ as H}from"./index-4c105ff6.js";class P{constructor({onMessageCallback:e,wsuri:o,maxReconnectCount:i,onOpenCallback:h}){s(this,"heartbeatStr","ping");s(this,"onMessageCallback");s(this,"wsuri","");s(this,"maxReconnectCount",5);s(this,"onOpenCallback");s(this,"pingCount",0);s(this,"websocket",null);s(this,"connectRetryCount",0);s(this,"timeoutnum");s(this,"heartbeat");this.onMessageCallback=e,this.wsuri=o,this.maxReconnectCount=i??this.maxReconnectCount,this.onOpenCallback=h,this.initWebsocket()}initWebsocket(){this.websocket=new WebSocket(this.wsuri),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onopen=this.onOpen.bind(this),this.websocket.onerror=this.onError.bind(this),this.websocket.onclose=this.onClose.bind(this)}onMessage(e){e.data!==this.heartbeatStr&&this.onMessageCallback(e.data)}onOpen(){var e;this.connectRetryCount=0,console.log("建立连接"),(e=this.onOpenCallback)==null||e.call(this)}send(e){this.websocket.send(e)}onClose(){console.log("连接关闭")}onError(e){this.reconnect(),console.error("出现错误",e.target)}sendHeart(){this.heartbeat&&clearTimeout(this.heartbeat),this.heartbeat=setTimeout(()=>{var e;if(((e=this.websocket)==null?void 0:e.readyState)==1){const o={type:this.heartbeat,payload:`${this.pingCount}`};this.send(JSON.stringify(o)),this.pingCount++}else this.reconnect()},1e3)}reconnect(){if(this.connectRetryCount>=this.maxReconnectCount){this.timeoutnum&&clearTimeout(this.timeoutnum);return}this.timeoutnum&&clearTimeout(this.timeoutnum),console.log(`尝试重新连接-第 ${this.connectRetryCount+1}次`),this.timeoutnum=setTimeout(()=>{this.initWebsocket(),this.connectRetryCount+=1},1e4)}destory(){var e;(e=this.websocket)==null||e.close(),this.heartbeat&&clearTimeout(this.heartbeat),this.timeoutnum&&clearTimeout(this.timeoutnum)}}const b=a=>(A("data-v-e9164697"),a=a(),L(),a),Q={class:"p2p-container"},z=b(()=>l("div",{class:"video-container"},[l("video",{id:"remote-video",class:"video-dom",autoplay:"",playsinline:""}),l("div",{class:"video-title"},"远程视频")],-1)),F=b(()=>l("div",{class:"video-container"},[l("video",{id:"local-video",class:"video-dom",autoplay:"",playsinline:""}),l("div",{class:"video-title"},"本地视频")],-1)),G={class:"operation"},X=b(()=>l("label",{class:"operation-label"},"房间号：",-1)),Y=B({__name:"single-remote",setup(a){const e=m(new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]})),o=m(e.value.createDataChannel("message",{ordered:!1,maxRetransmits:0})),i=m(new MediaStream),h=m(""),f=m(!0);let _;const C=t=>{try{const n=JSON.parse(t);if(console.log(n),n.type==="answer"){const r=new RTCSessionDescription(n.payload);S(r)}else n.type}catch(n){console.error(n)}},g=()=>{if(!h.value){y.error("请输入房间号");return}_=new P({wsuri:"ws://10.1.60.209:8080",onMessageCallback:C,onOpenCallback:k}),h.value=""},w=async()=>{const t=document.getElementById("local-video"),n=document.getElementById("remote-video");i.value=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:!0}),t.srcObject=i.value,i.value.getTracks().forEach(c=>{e.value.addTrack(c,i.value)});const r=new MediaStream;e.value.ontrack=c=>{c.streams[0].getTracks().forEach(d=>{r.addTrack(d)}),n.srcObject=r},i.value.getAudioTracks().forEach(c=>{c.enabled=!1}),o.value.onopen=()=>{console.log("Data channel opened!")},e.value.ondatachannel=c=>{y.success("建立连接"),f.value=!1;const d=c.channel;d.onopen=()=>{d.send("建立连接!")},d.onmessage=v=>{console.log(v.data)}}};async function k(){e.value.onicecandidate=async t=>{t.candidate&&_.send(JSON.stringify({type:"candidate",payload:t.candidate}))};try{const t=await e.value.createOffer();await e.value.setLocalDescription(t),_.send(JSON.stringify({type:"offer",payload:t}))}catch(t){console.error(t)}}async function S(t){await e.value.setRemoteDescription(t),_.destory()}function R(){i.value.getTracks().forEach(t=>{t.stop()}),e.value.close()}return W(()=>{w()}),J(()=>{R()}),(t,n)=>{const r=M,c=D,d=I,v=V,T=N;return U(),j("div",Q,[u(c,{class:"p2p-container__row"},{default:p(()=>[u(r,{span:12},{default:p(()=>[z]),_:1}),u(r,{span:12},{default:p(()=>[F]),_:1})]),_:1}),l("div",G,[u(T,{class:"box-card"},{default:p(()=>[X,u(d,{modelValue:h.value,"onUpdate:modelValue":n[0]||(n[0]=E=>h.value=E),style:{width:"150px","margin-right":"20px"},placeholder:"要加入的房间号",clearable:"",onKeyup:K(g,["enter"])},null,8,["modelValue","onKeyup"]),u(v,{type:"primary",onClick:g},{default:p(()=>[$("加入")]),_:1})]),_:1}),u(q,{localStream:i.value,peerConnection:e.value,dataChannel:o.value,btnDiabled:f.value,ref:"consoleRef"},null,8,["localStream","peerConnection","dataChannel","btnDiabled"])])])}}});const ne=H(Y,[["__scopeId","data-v-e9164697"]]);export{ne as default};
