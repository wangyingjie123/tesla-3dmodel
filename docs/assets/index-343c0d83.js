import{m as z,P as L,Q as q,R as K,S as W,T as H,k as Q,U as j}from"./vendor-bdc55dd3.js";import{d as J,r as S,a as g,e as O,A as G,k as B,l as D,J as X,m as F,S as m,Q as f,a5 as R,U as Y,a7 as Z,T as ee}from"./@vue-83231dd6.js";import{_ as te}from"./index-6be28e0b.js";const ae=""+new URL("../video/dance.mp4",import.meta.url).href,ne=(c,n=0,r=0)=>{if(c&&n&&r){const a=document.createElement("canvas"),l=a.getContext("2d");return a.width=n,a.height=r,l.drawImage(c,0,0,n,r),l.getImageData(0,0,n,r)}return null},oe=c=>{if(!c)return null;const{width:n,height:r}=c,a=document.createElement("canvas"),l=a.getContext("2d");return a.width=n,a.height=r,l.putImageData(c,0,0,0,0,n,r),a.toDataURL("image/png")},se={class:"danmu"},re={class:"danmu-video","element-loading-text":"人物检测模型加载中... ","element-loading-background":"rgba(0, 0, 0, 0.7)"},le=J({__name:"index",setup(c){const n=S({message:""}),r=g(!0),a=g(),l=g(),d=g(0),w=g(),U=10,x=16,M=4,T=2,E=!1,N=.3,b=new WeakMap;let u=0,k=0,_=0,v;const P=S({message:[{required:!0,message:"请输入一个弹幕",trigger:"change"}]}),C=async()=>{const e=ne(a.value,u,k);if(e){const o={flipHorizontal:!1,multiSegmentaion:!1,segmentBodyParts:!1,segmentationThreshold:1},s=await(v==null?void 0:v.segmentPeople(e,o)),y=await j(s,{r:0,g:0,b:0,a:0},{r:0,g:0,b:0,a:255},E,N),p=oe(y);l.value.style["-webkit-mask-image"]=`url(${p})`,l.value.style["-webkit-mask-size"]=`${u}px ${k}px`}d.value===1&&(_=window.requestAnimationFrame(C))},h=e=>{const{left:o}=e.style,s=Number(o.replace("px",""));if(s>=-u){e.style.left=`${s-T}px`;const i=window.requestAnimationFrame(()=>h(e));b.set(e,i);return}e&&(e.parentNode.removeChild(e),window.cancelAnimationFrame(b.get(e)),b.delete(e))},I=async()=>{var e;await((e=w.value)==null?void 0:e.validate((o,s)=>{var i;if(o){const t=document.createElement("span");t.innerText=n.message,t.style.fontSize=`${x}px`,t.style.fontWeight="500",t.style.color="#fff",t.style.whiteSpace="nowrap",t.style.position="absolute";const p=Math.floor(Math.random()*U)*(x+M)+x;t.style.top=`${p}px`,t.style.left=`${u}px`,l.value.appendChild(t),h(t),(i=w.value)==null||i.resetFields()}else console.log("error submit!",s)}))},V=()=>{const e=a.value;e.paused?(e.play(),d.value=1,C()):(e.pause(),d.value=2,window.cancelAnimationFrame(_))},$=async()=>{const e=W.MediaPipeSelfieSegmentation,o={runtime:"mediapipe",modelType:"landscape",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"};try{v=await H(e,o),r.value=!1;const{width:i,height:t}=a.value.getBoundingClientRect();u=i,k=t,C()}catch(s){console.log(s)}};return O(()=>$()),G(()=>{_&&window.cancelAnimationFrame(_)}),(e,o)=>{const s=Q,i=z,t=L,y=q,p=K;return B(),D("div",se,[X((B(),D("div",re,[F("video",{src:ae,class:"danmu-video-inner",preload:"true",ref_key:"videoRef",ref:a,loop:"","x5-video-player-fullscreen":"true","x5-playsinline":"true",playsInline:"","webkit-playsinline":"true",crossOrigin:"anonymous"},null,512),F("div",{class:"danmu-mask",ref_key:"barrageBoxRef",ref:l},null,512),m(s,{type:"primary",class:"danmu-video-btn",onClick:V},{default:f(()=>[R(Y(d.value===1?"暂停":"播放"),1)]),_:1})])),[[p,r.value]]),m(y,{inline:!0,model:n,rules:P,disabled:r.value,ref_key:"ruleFormRef",ref:w,onSubmit:o[1]||(o[1]=ee(()=>{},["stop","prevent"]))},{default:f(()=>[m(t,{label:"",prop:"message",class:"danmu-input"},{default:f(()=>[m(i,{modelValue:n.message,"onUpdate:modelValue":o[0]||(o[0]=A=>n.message=A),placeholder:"发送弹幕",onKeyup:Z(I,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),m(t,null,{default:f(()=>[m(s,{type:"primary",onClick:I},{default:f(()=>[R("发送")]),_:1})]),_:1})]),_:1},8,["model","rules","disabled"])])}}});const me=te(le,[["__scopeId","data-v-c1dc70a2"]]);export{me as default};
