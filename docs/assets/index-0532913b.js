var C=(e,o,t)=>new Promise((s,c)=>{var a=n=>{try{l(t.next(n))}catch(r){c(r)}},v=n=>{try{l(t.throw(n))}catch(r){c(r)}},l=n=>n.done?s(n.value):Promise.resolve(n.value).then(a,v);l((t=t.apply(e,o)).next())});import{d as L,r as m,o as f,c as w,a as b,w as S,b as k,t as D,E as M,_ as E,e as u,f as U,g as V,F as $,h as B,i as I,v as T,p as F,j}from"./index-94e44db4.js";function O({stream:e,onstop:o}){const t={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:'video/webm; codecs="vp8,opus"'},s=new MediaRecorder(e,t);return s.start(),s.ondataavailable=c=>{const a=new Blob([c.data],{type:c.data.type});P(a)},s.onstop=c=>{console.log(`停止录制 ${c.type}`),o()},s}function P(e){const o=URL.createObjectURL(e),t=document.createElement("a");t.href=o,t.download=`${new Date().getTime()}.${e.type.split("/")[1]}`,t.click(),URL.revokeObjectURL(o)}const q={class:"shared"},H=L({__name:"shared",emits:["playStream"],setup(e,{emit:o}){const t=m(),s=m(!1);let c=null;const a=()=>{if(t.value){if(s.value){c==null||c.stop();return}s.value=!0,c=O({stream:t.value,onstop:()=>{s.value=!1}})}};function v(){return C(this,null,function*(){t.value=yield navigator.mediaDevices.getDisplayMedia({audio:!0,video:!0}),o("playStream",t.value)})}return(l,n)=>{const r=M;return f(),w("div",q,[b(r,{class:"margin-right-10",type:"success",onClick:v},{default:S(()=>[k("屏幕共享")]),_:1}),b(r,{type:s.value?"warning":"primary",onClick:a},{default:S(()=>[k(D(s.value?"停止录制":"开始录制"),1)]),_:1},8,["type"])])}}});function G(e,o){const t=e[0]-o[0],s=e[1]-o[1],c=e[2]-o[2];return Math.sqrt(t*t+s*s+c*c)}function N({realVideoImageData:e,backgroundImageData:o,backgroundColor:t,allowance:s,virtualVideoCtx:c}){for(let a=0;a<e.data.length;a+=4){const v=e.data[a],l=e.data[a+1],n=e.data[a+2],r=o.data[a],h=o.data[a+1],g=o.data[a+2],y=o.data[a+3];G([v,l,n],t)<s&&(e.data[a]=r,e.data[a+1]=h,e.data[a+2]=g,e.data[a+3]=y)}return c.putImageData(e,0,0),e}const A=L({setup(){const e=m();function o(){const l=e.value.getContext("2d",{willReadFrequently:!0}),n=new Image;return n.setAttribute("crossOrigin",""),new Promise(r=>{n.src="https://t7.baidu.com/it/u=1819248061,230866778&fm=193&f=GIF",n.onload=()=>{l.drawImage(n,0,0,e.value.width,e.value.height);const h=l.getImageData(0,0,e.value.width,e.value.height);r(h)}})}const t=480,s=300;function c(l,n){const r=document.createElement("canvas"),h=r.getContext("2d",{willReadFrequently:!0}),g=document.createElement("canvas"),y=g.getContext("2d");r.width=g.width=t,r.height=g.height=s,setInterval(()=>{h.drawImage(l,0,0,r.width,r.height);const i=h.getImageData(0,0,r.width,r.height);N({backgroundImageData:n,realVideoImageData:i,virtualVideoCtx:y,allowance:50,backgroundColor:[245,245,245]})},40),a(g)}function a(l){const n=document.querySelector("#virtual-video"),r=l.captureStream(30);n.srcObject=r}return{virtualVideoCanvas:e,onMounted:l=>{o().then(n=>{c(l,n)})}}}}),W={class:"videos margin-top-20"},z={ref:"virtualVideoCanvas",class:"margin-right-10",width:"480",height:"300"},J=u("video",{id:"virtual-video",width:"480",height:"300",autoplay:"",muted:""},null,-1);function K(e,o,t,s,c,a){return f(),w("div",W,[u("canvas",z,null,512),J])}const Q=E(A,[["render",K]]),R=e=>(F("data-v-aa32f7fc"),e=e(),j(),e),X={class:"webrtc"},Y={class:"webrtc-video margin-right-20"},Z={class:"webrtc-img"},ee=["src"],te={class:"webrtc-device margin-left-20"},ae={class:"webrtc-device__list"},oe=R(()=>u("label",{class:"webrtc-device__label"},"切换设备",-1)),ne=["value"],se={class:"webrtc-device__list"},ce=R(()=>u("label",{class:"webrtc-device__label"},"切换方向",-1)),ie=R(()=>u("option",{value:1},"前置摄像头",-1)),re=R(()=>u("option",{value:2},"后置摄像头",-1)),de=[ie,re],le=L({__name:"index",setup(e){const o=m(),t=m([]),s=m(),c=m([]),a=m(1);let v;function l(i){return C(this,null,function*(){v=yield navigator.mediaDevices.getUserMedia(i),n(v)})}function n(i){o.value.srcObject=i}function r(){const i=o.value,d=document.createElement("canvas");d.width=i.videoWidth,d.height=i.videoHeight;const p=d.getContext("2d");p.drawImage(i,0,0,d.width,d.height),t.value.push(d.toDataURL("image/png"));const _=["blur(5px)","brightness(0.5)","contrast(200%)","grayscale(100%)","hue-rotate(90deg)","invert(100%)","opacity(90%)","saturate(200%)","saturate(20%)","sepia(100%)","drop-shadow(4px 4px 8px blue)"];t.value=[];for(let x=0;x<_.length;x++)p.filter=_[x],p.drawImage(i,0,0,d.width,d.height),t.value.push(d.toDataURL("image/png"))}const h=()=>{const i={video:!0,audio:!0};i.video={facingMode:{exact:a.value===1?"user":"environment"}},navigator.mediaDevices.getUserMedia(i).then(d=>{console.log("切换成功"),n(d)}).catch(d=>{console.error(`你的设备不支持切换前后摄像头 ${d}`)})};function g(){return C(this,null,function*(){const i=yield navigator.mediaDevices.enumerateDevices();console.log("🚀🚀🚀 / 设备列表",i);const d=i.filter(p=>p.kind==="videoinput");c.value=d,console.log("🚀🚀🚀 / 摄像头列表",d)})}const y=()=>{var i;(i=s.value)==null||i.onMounted(o.value)};return U(()=>{l({video:!0,audio:!0}),g()}),V(()=>{v.getVideoTracks().forEach(i=>{i.enabled=!1})}),(i,d)=>{const p=M;return f(),w($,null,[u("div",X,[u("div",Y,[u("video",{ref_key:"video",ref:o,class:"webrtc-video__inner",width:"480",height:"300",autoplay:"",playsinline:"",muted:""},null,512),b(p,{type:"primary",onClick:r,class:"button"},{default:S(()=>[k("拍摄")]),_:1}),b(p,{onClick:y},{default:S(()=>[k("设置虚拟背景")]),_:1})]),u("div",Z,[(f(!0),w($,null,B(t.value,(_,x)=>(f(),w("img",{key:x,src:_,alt:"",class:"webrtc-img__item margin-right-10 margin-bottom-10"},null,8,ee))),128))]),u("div",te,[u("div",ae,[oe,u("select",null,[(f(!0),w($,null,B(c.value,_=>(f(),w("option",{key:_.deviceId,value:_.deviceId},D(_.label),9,ne))),128))])]),u("div",se,[ce,I(u("select",{"onUpdate:modelValue":d[0]||(d[0]=_=>a.value=_),onChange:h},de,544),[[T,a.value]])]),b(H,{onPlayStream:n})])]),b(Q,{ref_key:"sonRef",ref:s},null,512)],64)}}});const _e=E(le,[["__scopeId","data-v-aa32f7fc"]]);export{_e as default};
